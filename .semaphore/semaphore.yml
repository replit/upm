---
version: v1.0
name: UPM
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  prologue:
    commands:
      - checkout
      - git switch --detach

blocks:
  - name: setup
    dependencies: []
    task:
      jobs:
        - name: cache nix installer
          commands:
            - >-
              curl
              --proto '=https'
              -o nix-installer
              --tlsv1.2 -sSf -L https://install.determinate.systems/nix
            - chmod +x ./nix-installer
            - cache store nix-installer ./nix-installer
  - name: build
    dependencies: [setup]
    task:
      prologue:
        commands:
          - cache restore nix-installer
          - sudo ./nix-installer install linux --no-confirm --logger compact
          - sudo systemctl start nix-daemon
      jobs:
        - name: find nix
          commands:
            - curl --proto '=https' -o fd.tar.gz --tlsv1.2 -sSf -L https://github.com/sharkdp/fd/releases/download/v8.7.0/fd-v8.7.0-x86_64-unknown-linux-gnu.tar.gz
            - tar xzvf fd.tar.gz
            - chmod +x ./fd-v8.7.0-x86_64-unknown-linux-gnu/fd
            - ./fd-v8.7.0-x86_64-unknown-linux-gnu/fd -gt x nix /
        - name: nix build
          commands:
            - systemctl status nix-daemon
            - nix build
