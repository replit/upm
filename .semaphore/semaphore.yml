---
version: v1.0
name: UPM
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  prologue:
    commands:
      - checkout
      - git switch --detach

blocks:
  - name: setup
    dependencies: []
    task:
      jobs:
        - name: cache nix installer
          commands:
            - >-
              curl
                --proto '=https'
                -o nix-installer
                --tlsv1.2 -sSf -L https://install.determinate.systems/nix
            - chmod +x ./nix-installer
            - cache store nix-installer ./nix-installer
  - name: build
    dependencies: [setup]
    prologue:
      commands:
        - cache restore nix-installer
        - ./nix-installer install linux --no-confirm --logger compact
        - systemctl start nix-daemon
    task:
      jobs:
        - name: nix build
          commands:
            - systemctl status nix-daemon
            - nix build
